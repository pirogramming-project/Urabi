<!-- chat/templates/chat/room_chat.html -->
{% extends "chat/base.html" %}
{% block title %}채팅방: {{ room.name }}{% endblock %}

{% block extra-style %}
<style>
  #chat_messages {
      height: 400px;
      border: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
  }
  .chat-message {
      margin-bottom: 0.5em;
  }
</style>
{% endblock %}

{% block content %}
<div class="container" style="margin-top:20px;">
    <h2>채팅방: {{ room.name }}</h2>
    <!-- 서버에서 초기 메시지 내역을 렌더링하거나, 비워둡니다. -->
    <div id="chat_messages">
      {% for msg in messages %}
        <div class="chat-message">
          {{ msg.sender.username }} [{{ msg.timestamp|date:"g:i A" }}]: {{ msg.content }}
        </div>
      {% endfor %}
    </div>
    <!-- 메시지 전송 폼 -->
    <form id="message_form" class="mt-3">
        {% csrf_token %}
        <input type="text" id="message_input" placeholder="메시지를 입력하세요..." autocomplete="off" style="width:80%;" class="form-control d-inline-block">
        <button type="submit" class="btn btn-primary">전송</button>
    </form>
</div>
{% endblock %}

{% block extra-script %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // DOM 요소 가져오기
    const chatMessages = document.getElementById("chat_messages");
    const messageForm = document.getElementById("message_form");
    const messageInput = document.getElementById("message_input");

    const myUsername = "{{ request.user.username }}";
    console.log("현재 사용자 이름:", myUsername);

    const protocol = location.protocol === "http:" ? "ws:" : "wss:";
    // WebSocket URL 구성: room.id와 access_token (여기서는 빈 문자열 사용)
    const wsUrl = protocol + "//" + location.host + "/ws/chat/{{ room.id }}/?token={{ access_token|default:'' }}";
    console.log("WebSocket URL:", wsUrl);
    const chatSocket = new WebSocket(wsUrl);

    // 최초 히스토리 로드를 한 번만 처리하기 위한 플래그
    let historyLoaded = false;

    chatSocket.onopen = function(event) {
    console.log("WebSocket 연결 성공!");
    // 이 부분에서 fetch_messages 요청을 전혀 보내지 않음
};

chatSocket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log("메시지 수신:", data);

    // 히스토리 타입
    if (data.type === "chat.history" && data.messages) {
        console.log("히스토리 수신, 메시지 개수:", data.messages.length);
        chatMessages.innerHTML = "";
        data.messages.forEach(function(msg, idx) {
            console.log("히스토리 메시지", idx, msg);
            appendMessage(msg.sender_nickname, msg.timestamp, msg.content);
        });
    }
    // 새 메시지 타입
    else if (data.type === "chat_message") {
        console.log("새 메시지 수신:", data);
        appendMessage(data.sender_nickname, data.timestamp, data.content);
    }
};


    chatSocket.onerror = function(error) {
        console.error("WebSocket 에러:", error);
    };

    chatSocket.onclose = function(event) {
        console.log("WebSocket 연결 종료됨:", event);
    };

    // 메시지 전송 폼 제출 시 처리 (서버에 메시지 전송만 하고, broadcast를 기다림)
    messageForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message !== "") {
            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({ content: message }));
            }
            messageInput.value = "";
        }
    });

    // 메시지를 채팅 영역에 추가하는 함수
    function appendMessage(sender, timestamp, content) {
        console.log("appendMessage 호출:", sender, timestamp, content);
        const msgElem = document.createElement("div");
        msgElem.className = "chat-message";
        const ts = new Date(timestamp).toLocaleTimeString();
        msgElem.textContent = `${sender} [${ts}]: ${content}`;
        chatMessages.appendChild(msgElem);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
    }
});
</script>
{% endblock %}
