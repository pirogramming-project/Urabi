<!-- chat/templates/chat/room_chat.html -->
{% extends "chat/base.html" %}
{% block title %}채팅방: {{ room }}{% endblock %}

{% block content %}
<div class="container" style="margin-top:20px;">
    <h2>채팅방: {{ room }}</h2>
    <!-- 채팅 메시지를 보여줄 영역 -->
    <div id="chat_messages" style="height:400px; border:1px solid #ccc; overflow-y: scroll; padding:10px;"></div>
    <!-- 메시지 전송 폼 -->
    <form id="message_form">
        {% csrf_token %}
        <input type="text" id="message_input" placeholder="메시지를 입력하세요..." autocomplete="off" style="width:80%;">
        <button type="submit">전송</button>
    </form>
</div>
{% endblock %}

{% block extra-script %}
<script>
    // DOM 요소 가져오기
    const chatMessages = document.getElementById("chat_messages");
    const messageForm = document.getElementById("message_form");
    const messageInput = document.getElementById("message_input");

    // 현재 프로토콜에 따라 ws:// 또는 wss:// 설정
    const protocol = location.protocol === "http:" ? "ws:" : "wss:";
    // WebSocket URL 구성: room.id와 access_token (JWT 사용 시; 여기서는 빈 문자열 사용)
    const wsUrl = protocol + "//" + location.host + "/ws/chat/{{ room.id }}/?token={{ access_token|default:'' }}";
    console.log("WebSocket URL:", wsUrl);
    const chatSocket = new WebSocket(wsUrl);

    // WebSocket 연결이 열리면 기존 메시지 내역을 요청
    chatSocket.onopen = function() {
        console.log("WebSocket 연결 성공:", wsUrl);
        // fetch_messages 커맨드를 서버에 보내 기존 메시지 내역을 요청
        chatSocket.send(JSON.stringify({ command: "fetch_messages" }));
    };

    // 메시지 수신 처리
    chatSocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log("메시지 수신:", data);
        // 기존 채팅 내역 (여러 메시지 배열로 전달되는 경우)
        if (data.type === "chat.history" && data.messages) {
            // 기존 내용을 초기화한 후, 모든 메시지를 추가
            chatMessages.innerHTML = "";
            data.messages.forEach(function(msg) {
                appendMessage(msg.sender_nickname, msg.timestamp, msg.content);
            });
        }
        // 단일 새 메시지인 경우
        else if (data.type === "chat.message") {
            appendMessage(data.sender_nickname, data.timestamp, data.content);
        }
    };

    // 오류 처리
    chatSocket.onerror = function(error) {
        console.error("WebSocket 에러:", error);
    };

    // 연결 종료 처리
    chatSocket.onclose = function(event) {
        console.log("WebSocket 연결 종료됨:", event);
    };

    // 메시지 전송 폼 제출 이벤트 처리
    messageForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message !== "") {
            // 서버로 메시지를 전송
            chatSocket.send(JSON.stringify({ content: message }));
            messageInput.value = "";
        }
    });

    // 채팅 메시지를 채팅 영역에 추가하는 함수
    function appendMessage(sender, timestamp, content) {
        const msgElem = document.createElement("div");
        const ts = new Date(timestamp).toLocaleTimeString();
        msgElem.textContent = `${sender} [${ts}]: ${content}`;
        chatMessages.appendChild(msgElem);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
{% endblock %}
