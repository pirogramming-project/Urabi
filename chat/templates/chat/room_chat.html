{% extends "chat/base.html" %}
{% block title %}채팅방: {{ room.name }}{% endblock %}

{% block extra-style %}
<style>
  /* 스타일은 그대로 둡니다 */
  #chat_messages {
      height: 400px;
      border: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container" style="margin-top:20px;">
    <h2>채팅방: {{ room.name }}</h2>
    <!-- 채팅 메시지를 보여줄 영역 -->
    <div id="chat_messages"></div>
    <!-- 메시지 전송 폼 -->
    <form id="message_form" class="mt-3">
        {% csrf_token %}
        <input type="text" id="message_input" placeholder="메시지를 입력하세요..." autocomplete="off" style="width:80%;" class="form-control d-inline-block">
        <button type="submit" class="btn btn-primary">전송</button>
    </form>
</div>
{% endblock %}

{% block extra-script %}
<script>
 document.addEventListener("DOMContentLoaded", function() {
    console.log("DOMContentLoaded: DOM 완전히 로드됨");

    const chatMessages = document.getElementById("chat_messages");
    const messageForm = document.getElementById("message_form");
    const messageInput = document.getElementById("message_input");

    const myUsername = "{{ request.user.username }}";
    console.log("현재 사용자 이름:", myUsername);

    const protocol = location.protocol === "http:" ? "ws:" : "wss:";
    const wsUrl = protocol + "//" + location.host + "/ws/chat/{{ room.id }}/?token={{ access_token|default:'' }}";
    console.log("WebSocket URL:", wsUrl);

    const chatSocket = new WebSocket(wsUrl);
    console.log("WebSocket 객체 생성:", chatSocket);

    chatSocket.onopen = function(event) {
        console.log("WebSocket 연결 성공!");
        // WebSocket 연결 후에만 메시지 전송
        const message = messageInput.value.trim();
        if (message !== "") {
            console.log("전송 전 WebSocket 상태:", chatSocket.readyState);
            chatSocket.send(JSON.stringify({ content: message }));
            console.log("전송 후 WebSocket 상태:", chatSocket.readyState);
            messageInput.value = ""; // 전송 후 입력란 비우기
        } else {
            console.log("빈 메시지 전송 시도됨");
        }
    };

    // WebSocket onmessage 이벤트
    chatSocket.onmessage = function(event) {
        console.log("onmessage 이벤트 발생:", event);
        try {
            const data = JSON.parse(event.data);
            console.log("수신된 데이터:", data);

            if (data.type === "chat.history" && data.messages) {
                console.log("기존 메시지 로드:", data.messages);
                data.messages.forEach(function(msg) {
                    appendMessage(msg.sender_nickname, msg.timestamp, msg.content);  // 메시지 추가
                });
            } else {
                console.log("새로운 메시지 수신:", data);
                appendMessage(data.sender_nickname, data.timestamp, data.content);  // 새로운 메시지 추가
            }
        } catch (e) {
            console.error("onmessage 오류:", e, event.data);
        }
    };

    // WebSocket onerror 이벤트
    chatSocket.onerror = function(error) {
        console.error("onerror: WebSocket 에러 발생:", error);
    };

    // WebSocket onclose 이벤트
    chatSocket.onclose = function(event) {
        console.log("WebSocket 연결 종료됨:", event);
        if (event.code !== 1000) {
            setTimeout(() => {
                chatSocket = new WebSocket(wsUrl);  // 연결 끊어졌을 때 재연결
            }, 1000);  // 1초 후 재연결
        }
    };

    messageForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message !== "") {
            console.log('전송 전 WebSocket 상태:', chatSocket.readyState);
            console.log("submit: 메시지 전송 중:", message);
            if (chatSocket.readyState === WebSocket.OPEN) {  // WebSocket이 OPEN 상태일 때만 전송
                chatSocket.send(JSON.stringify({ content: message }));
                console.log('전송 후 WebSocket 상태:', chatSocket.readyState);
            }
            messageInput.value = "";
        } else {
            console.log("submit: 빈 메시지 무시");
        }
    });

    // appendMessage 함수
    function appendMessage(sender, timestamp, content) {
        console.log("appendMessage 호출:", sender, timestamp, content);

        const msgElem = document.createElement("div");
        const ts = new Date(timestamp).toLocaleTimeString();
        msgElem.textContent = `${sender} [${ts}]: ${content}`;

        chatMessages.appendChild(msgElem);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        console.log("현재 chatMessages.innerHTML:", chatMessages.innerHTML);
    }
});

</script>
{% endblock %}
