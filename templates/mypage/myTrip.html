<!-- templates/mypage/myTrip.html -->

{% extends "base/base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static 'mypage/myTrip.css' %}">
  <link rel="stylesheet" href="{% static 'accompany/accompany_map.css' %}">
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZLQne-DOUQDfifh3ZP_79TmL2OmBOI7k&libraries=places&callback=initMap&loading=async"></script>
{% endblock %}

{% block content %}
<main class="mypage-wrap">
  <nav class="mypage-nav">
    <ul>
      <li><a href="{% url 'users:my_page' %}">프로필</a></li>
      <li><a href="{% url 'users:zzim_list' %}">찜 목록</a></li>
      <li class="active"><a href="{% url 'users:user_list' %}">나의 여행 일정</a></li>
      <li><a href="{% url 'users:user_detail' user.id %}">내 활동 관리</a></li>
    </ul>
  </nav>

  <section class="mypage-content">
    <h1 class="main-title">{{ this_schedule.name }}</h1>
    <section class="profile-section">
      <div class="profile-header">
        <div class="section-title">하루 일정 생성/수정</div>
        <a href="{% url 'users:schedule_detail' this_schedule.schedule_id %}">목록으로</a>
      </div>

      <!-- 날짜 드롭다운 -->
      <div class="date-dropdown">
        <label for="plan_date_select">날짜 선택:</label>
        <select id="plan_date_select" name="plan_date_select" onchange="changeHiddenDate(this.value)">
          {% for d in date_list %}
            <option value="{{ d|date:'Y-m-d' }}"
                    {% if d == selected_date %}selected{% endif %}>
              {{ d|date:"Y-m-d" }}
            </option>
          {% endfor %}
        </select>
      </div>

      {% if form.instance.markers %}
        {% with form.instance.markers|default:'[]' as markers_json %}
          {% autoescape off %}
          <script>
            window.mapData = {
              markers: {{ markers_json }},
              polyline: {{ form.instance.polyline|default:'[]' }}
            };
          </script>
          {% endautoescape %}
        {% endwith %}
      {% endif %}

      <div class="map-container">
        <input id="search-bar" type="text" placeholder="장소를 검색하세요">
        <div id="map"></div>
      </div>

      <div id="address_container"></div>
      <div class="marker-timeline">
        <h3>추가된 장소</h3>
        <ul id="marker-list">
          <li>등록된 장소가 없습니다.</li>
        </ul>
      </div>

      <form method="POST" action="">
        {% csrf_token %}
        {% if travel_plan %}
          <input type="hidden" name="plan_id" value="{{ travel_plan.plan_id }}">
        {% endif %}
        <input type="hidden" id="plan_date" name="plan_date" value="{{ selected_date|date:'Y-m-d' }}">

        <!-- markers/polyline -->
        <input type="hidden" id="markers" name="markers" value='{{ form.instance.markers|default:"[]"|escapejs }}'>
        <input type="hidden" id="polyline" name="polyline" value='{{ form.instance.polyline|default:"[]"|escapejs }}'>

        <label for="explanation">설명</label>
        {{ form.explanation }}

        <button type="submit" class="register-btn">등록하기</button>
      </form>
      <!-- 폼 끝 -->

    </section>
  </section>
</main>
{% endblock %}

{% block js %}
<script>
  function changeHiddenDate(newDate) {
    document.getElementById("plan_date").value = newDate;
  }
</script>

<script src="{% static 'accompany/accompany_map.js' %}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    let markersData = [];
    const markersDataEl = document.getElementById("markers_data");
    if (markersDataEl) {
      try {
        markersData = JSON.parse(markersDataEl.textContent);
      } catch (e) {
        markersData = [];
      }
    }
    const markerList = document.getElementById("marker-list");
    if (markersData && markersData.length > 0) {
      markerList.innerHTML = "";
      markersData.forEach(function(marker) {
        const li = document.createElement("li");
        li.textContent = marker.customName || marker.title || "장소 없음";
        markerList.appendChild(li);
      });
    }
  });
</script>
{% endblock %}

