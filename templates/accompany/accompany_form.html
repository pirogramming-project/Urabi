{% extends "base/base.html" %}
{% load static %}
{% block head %}
  <link rel="stylesheet" href="{%static 'accompany/accompany_create.css'%}">
  <link rel="stylesheet" href="{%static 'accompany/accompany_map.css'%}">
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZLQne-DOUQDfifh3ZP_79TmL2OmBOI7k&libraries=places&callback=initMap&loading=async" ></script>
{%endblock%}

{%block content%}
<section class="banner">
  <h2>함께 쌓는 추억, <span class="red">장기 동행</span> > 동행 모집하기</h2>
  <div class="plan-selection">
    <select id="plan-selector">
      <option value="">일정을 선택하세요</option>
      {% for plan in travel_plans %}
      <option value="{{ plan.plan_id }}">{{ plan.title }} ({{ plan.start_date }} ~ {{ plan.end_date }})</option>
      {% endfor %}
    </select>
    <button onclick="loadSelectedPlan()">불러오기</button>
  </div>
</section>
<section class="map">
  <div class="map-container">
    <input id="search-bar" type="text" placeholder="장소를 검색하세요">
    <div id="map"></div>
  </div>
</section>
<section class="form">
  <div class="banner-filter">
    <form class="filter-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" id="latitude" name="latitude">
      <input type="hidden" id="longitude" name="longitude">
      <input type="hidden" id="markers" name="markers" value="{{ form.instance.markers|default:'[]'|escapejs }}">
      <input type="hidden" id="polyline" name="polyline" value="{{ form.instance.polyline|default:'[]'|escapejs }}">

      <div class="title">
        {{form.title}}
      </div>
        <div class="info">
          <div class="filter-group-first">
            <div class="filter-group">
              {{form.city}}
            </div>
            <div class="filter-group">
              {{form.gender}}
            </div>
            <div class="filter-group">
              {{form.max_member}}
            </div>
            <div class="filter-group">
              {{form.start_date}}
            </div>
            <div class="filter-group">
              {{form.end_date}}
            </div>
          </div>
          <div class="filter-group-second">
            <div class="filter-group filter_age">
              {{form.min_age}}
            </div>
            <div class="filter-group filter_age">
              {{form.max_age}}
            </div>
            <div class="filter-group update-image">
                <input type="text" id="image-name" name="image-name" placeholder="사진을 추가해주세요">
                <label for="image-upload" class="file-upload">
                  <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24"><path fill="currentColor" d="M5 3h13a3 3 0 0 1 3 3v13a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3m0 1a2 2 0 0 0-2 2v11.59l4.29-4.3l2.5 2.5l5-5L20 16V6a2 2 0 0 0-2-2zm4.79 13.21l-2.5-2.5L3 19a2 2 0 0 0 2 2h13a2 2 0 0 0 2-2v-1.59l-5.21-5.2zM7.5 6A2.5 2.5 0 0 1 10 8.5A2.5 2.5 0 0 1 7.5 11A2.5 2.5 0 0 1 5 8.5A2.5 2.5 0 0 1 7.5 6m0 1A1.5 1.5 0 0 0 6 8.5A1.5 1.5 0 0 0 7.5 10A1.5 1.5 0 0 0 9 8.5A1.5 1.5 0 0 0 7.5 7"/></svg>
                </label>
                {%if not form.instance%}
                  {{form.photo}}
                {%else%}
                  <input type="file" id="image-upload" name="photo" accept="image/*">
                {%endif%}
            </div>
          </div>
      </div>

      <div class="filter-group filter_location">
        <label for="location">주소</label>
        <input type="text" id="location" name="location" readonly>
        <div id="address_container">
        </div>
      </div>

      <div class="description">
        {{form.explanation}}
      </div>
      <div class="imgs">
        {%if form.instance.photo%}
        <img src="{{form.instance.photo.url}}" alt="photo">
        {%endif%}
      </div>
      <div class="tags">
        <span>장소 태그</span>
        <div class="input_group">
            <div class="tag_input_container">
                <input type="text" id="tag_input" placeholder="#태그 입력">
                <button type="button" id="add_tag_btn">+</button>
            </div>
            <div class="tag_list"></div>
            <input type="hidden" name="tags" id="tags_hidden" value="{{ form.instance.tags|default:'' }}">
        </div>
      </div>
      <button type="submit">등록하기</button>
    </form>
  </div>
</section>
{%endblock%}

{%block js%}
<script src="{%static 'accompany/accompany_form.js'%}"></script>
<script src="{%static 'accompany/accompany_map.js'%}"></script>
<script>
  function loadSelectedPlan() {
    const planId = document.getElementById('plan-selector').value;
    if (planId) {
      const url = "{% url 'accompany:accompany_create' %}?plan_id=" + planId;
      window.location.href = url;
    }
  }

  {%if this_plan %}
  window.mapData = {
    markers: {{ this_plan.markers|safe }},
    polyline: {{ this_plan.polyline|safe }}
  };
  {%else%}
    window.mapData = {
      markers: {{ form.instance.markers|safe }},
      polyline: {{ form.instance.polyline|safe }}
    };
    {%endif%}
</script>

{%endblock js%}