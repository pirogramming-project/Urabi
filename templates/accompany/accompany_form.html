{% extends "base/base.html" %}
{% load static %}
{% block head %}
  <link rel="stylesheet" href="{%static 'accompany/accompany_create.css'%}">
  <link rel="stylesheet" href="{%static 'accompany/accompany_map.css'%}">
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZLQne-DOUQDfifh3ZP_79TmL2OmBOI7k&libraries=places&callback=initMap" ></script>
{%endblock%}

{%block content%}
<section class="banner">
  <h2>함께 쌓는 추억, <span class="red">장기 동행</span> > 동행 모집하기</h2>
</section>
<section class="map">
  <div class="map-container">
    <input id="search-bar" type="text" placeholder="장소를 검색하세요">
    <div id="map"></div>
  </div>
</section>
<section class="form">
  <div class="banner-filter">
    <form class="filter-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="title">
        {{form.title}}
      </div>
      <div class="info">
        <div class="filter-group">
          {{form.city}}
        </div>
        <div class="filter-group">
          {{form.max_member}}
        </div>
        <div class="filter-group">
          {{form.start_date}}
        </div>
        <div class="filter-group">
          {{form.end_date}}
        </div>
        <div class="filter-group update-image">
            <input type="text" id="image-name" name="image-name">
            <label for="image-upload" class="file-upload">
              <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24"><path fill="currentColor" d="M5 3h13a3 3 0 0 1 3 3v13a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3m0 1a2 2 0 0 0-2 2v11.59l4.29-4.3l2.5 2.5l5-5L20 16V6a2 2 0 0 0-2-2zm4.79 13.21l-2.5-2.5L3 19a2 2 0 0 0 2 2h13a2 2 0 0 0 2-2v-1.59l-5.21-5.2zM7.5 6A2.5 2.5 0 0 1 10 8.5A2.5 2.5 0 0 1 7.5 11A2.5 2.5 0 0 1 5 8.5A2.5 2.5 0 0 1 7.5 6m0 1A1.5 1.5 0 0 0 6 8.5A1.5 1.5 0 0 0 7.5 10A1.5 1.5 0 0 0 9 8.5A1.5 1.5 0 0 0 7.5 7"/></svg>
            </label>
            {%if not form.instance%}
              {{form.photo}}
            {%else%}
              <input type="file" id="image-upload" name="photo" accept="image/*">
            {%endif%}
        </div>
      </div>
      <div class="filter-group">
        <label for="location">주소</label>
        <input type="text" id="location" name="location" placeholder="주소를 입력하세요" readonly>
      </div>
      <div class="description">
        {{form.explanation}}
      </div>
      <div class="imgs">
        {%if form.instance.photo%}
        <img src="{{form.instance.photo.url}}" alt="photo">
        {%endif%}
      </div>
      <div class="tags">
        <span>장소 태그</span>
        <div class="input_group">
            <div class="tag_input_container">
                <input type="text" id="tag_input" placeholder="#태그 입력">
                <button type="button" id="add_tag_btn">+</button>
            </div>
            <div class="tag_list"></div>
            <input type="hidden" name="tags" id="tags_hidden" value="{{ form.instance.tags|default:'' }}">
        </div>
      </div>
      <button type="submit">등록하기</button>
    </form>
  </div>
</section>
{%endblock%}

{%block js%}
<script src="{%static 'accompany/accompany_form.js'%}"></script>
<script src="{%static 'accompany/accompany_map.js'%}"></script>
{% comment %} <script>
  let map;
  let marker;
  function initMap() {
      // 현재 위치를 가져오기 위한 기본 설정
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
  
          // 구글 지도 초기화
          map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: lat, lng: lng },
            zoom: 15
          });
  
          // 현재 위치에 마커 추가
          marker = new google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: map,
            title: "현재 위치"
          });
        }, function() {
          alert("위치를 가져올 수 없습니다.");
        });
      } else {
        alert("이 브라우저는 위치 서비스를 지원하지 않습니다.");
      }
  
      // 검색 바에 자동 완성 기능 추가
      const input = document.getElementById("search-bar");
      const autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.setFields(["place_id", "geometry"]);
  
      // 검색한 장소의 위치로 지도 이동
      autocomplete.addListener("place_changed", function() {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          alert("해당 장소를 찾을 수 없습니다.");
          return;
        }
  
        // 마커 위치 업데이트
        if (marker) {
          marker.setPosition(place.geometry.location);
        } else {
          marker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name
          });
        }
  
        // 지도 중심을 검색한 장소로 이동
        map.setCenter(place.geometry.location);
        map.setZoom(15);
      });
    }
    window.initMap = initMap;
</script> {% endcomment %}
{%endblock js%}