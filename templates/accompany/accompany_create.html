{% extends "base/base.html" %}
{% load static %}
{% block head %}
  <link rel="stylesheet" href="{%static 'accompany/accompany_create.css'%}">
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZLQne-DOUQDfifh3ZP_79TmL2OmBOI7k&callback=initMap"></script>
{%endblock%}

{%block content%}
<section class="banner">
  <h2>함께 쌓는 추억, <span class="red">장기 동행</span> > 동행 모집하기</h2>
</section>
<section class="map">
  <div class="map-container">
    <div id="map" class="accompany_map" style="position: relative; width: 100%; height: 100%;"></div>
  </div>
</section>
<section class="form">
  <div class="banner-filter">
    <form class="filter-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <input type="hidden" id="latitude" name="latitude" value="{{ flash.latitude|default:'' }}">
      <input type="hidden" id="longitude" name="longitude" value="{{ flash.longitude|default:'' }}">

      <div class="title">
        {{form.title}}
      </div>
      <div class="info">
        <div class="filter-group">
          {{form.city}}
        </div>
        <div class="filter-group">
          {{form.max_member}}
        </div>
        <div class="filter-group">
          {{form.start_date}}
        </div>
        <div class="filter-group">
          {{form.end_date}}
        </div>
        <div class="filter-group ">
            <input type="text" id="image-name" name="image-name">
            <label for="image-upload" class="file-upload">
              <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24"><path fill="currentColor" d="M5 3h13a3 3 0 0 1 3 3v13a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3m0 1a2 2 0 0 0-2 2v11.59l4.29-4.3l2.5 2.5l5-5L20 16V6a2 2 0 0 0-2-2zm4.79 13.21l-2.5-2.5L3 19a2 2 0 0 0 2 2h13a2 2 0 0 0 2-2v-1.59l-5.21-5.2zM7.5 6A2.5 2.5 0 0 1 10 8.5A2.5 2.5 0 0 1 7.5 11A2.5 2.5 0 0 1 5 8.5A2.5 2.5 0 0 1 7.5 6m0 1A1.5 1.5 0 0 0 6 8.5A1.5 1.5 0 0 0 7.5 10A1.5 1.5 0 0 0 9 8.5A1.5 1.5 0 0 0 7.5 7"/></svg>
            </label>
            {{form.photo}}
        </div>
      </div>
      <div class="filter-group">
        <label for="location">주소</label>
        <input type="text" id="location" name="location" placeholder="주소를 입력하세요" readonly>
      </div>  
      <div class="description">
        {{form.explanation}}
      </div>
      <div class="tags">
        <span>장소 태그</span>
        {{form.tags}}
      </div>
      <button type="submit">등록하기</button>
    </form>
  </div>
</section>
{%endblock%}

{%block js%}
  <script>
    function initMap() {
        console.log("initMap 실행됨");

        const defaultLocation = { lat: 37.5665, lng: 126.9780 }; // 기본 위치: 서울
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: defaultLocation
        });


        // 기본 마커 생성
        let marker = new google.maps.Marker({
          position: defaultLocation,
          map: map,
          draggable: true
        });

        //다중 마커
        fetch("/get_locations/")
          .then(response => response.json())
          .then(data => {
            data.forEach(location => {
              let newMarker = new google.maps.Marker({
                position : {lat : location.latitude, lng: location.longitude},
                map : map,
                draggable : true
              });


              //마커의 정보창 띄우기
              let infoWindow = new google.maps.InfoWindow({
                content: `<b>${location.name}</b>`
              });

              marker.addListener("click", () => {
                infoWindow.open(map,newMarker);  
              });
            });
          });

        // Geocoder 인스턴스 생성 (위도/경도를 주소로 변환)
        const geocoder = new google.maps.Geocoder();

        // 사용자가 지도 클릭하면 마커 이동 + 위도/경도 업데이트 + 주소 가져오기
        google.maps.event.addListener(map, "click", function(event) {
            updateLocation(event.latLng, geocoder, marker);
        });

        // 마커를 드래그해서 위치 변경할 때
        google.maps.event.addListener(marker, "dragend", function(event) {
            updateLocation(event.latLng, geocoder, marker);
        });

        // 기존 데이터가 있으면 해당 위치로 이동
        const existingLat = parseFloat(document.getElementById("latitude").value);
        const existingLng = parseFloat(document.getElementById("longitude").value);
        if (!isNaN(existingLat) && !isNaN(existingLng) && existingLat !== 0 && existingLng !== 0) {
            const existingLocation = { lat: existingLat, lng: existingLng };
            map.setCenter(existingLocation);
            marker.setPosition(existingLocation);
            updateLocation(existingLocation, geocoder, marker);
        }
    }
    //내가 추가
    window.initMap = initMap;

    function updateLocation(latLng, geocoder, marker) {
        marker.setPosition(latLng);
        document.getElementById("latitude").value = latLng.lat();
        document.getElementById("longitude").value = latLng.lng();

        // Geocoder를 사용하여 주소 변환
        geocoder.geocode({ location: latLng }, function(results, status) {
            if (status === "OK") {
                if (results[0]) {
                    document.getElementById("location").value = results[0].formatted_address;
                } else {
                    document.getElementById("location").value = "주소를 찾을 수 없음";
                }
            } else {
                console.error("Geocoder 실패: " + status);
                document.getElementById("location").value = "주소 변환 오류";
            }
        });
    }


    document.getElementById('image-upload').addEventListener('change', function() {
      const fileInput = document.getElementById('image-upload');
      const textInput = document.getElementById('image-name');
      if (fileInput.files.length > 0) {
          textInput.value = fileInput.files[0].name;
      } else {
          textInput.value = ''; // 파일이 선택되지 않았을 때
      }
  });
</script>
{%endblock js%}