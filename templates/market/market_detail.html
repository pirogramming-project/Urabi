{% extends 'base/base.html' %}
{% load static %}

{% block head%} 
<link rel="stylesheet" href="{% static 'market/market_detail.css' %}">
{% endblock %}

{% block content%}
<div class="market_detail_head">
    <div class="market_detail_head_group">
        <a class="market_link" href="{% url 'market:market_list' %}">나눔 마켓 ></a>
        <a class="market_detail_link" href="#">상세 정보 </a>
    </div>
    <div class="market_detail_title">
        <div class="market_detail_title_info">
            <h1>{{market.title}}</h1>
            <div class="market_detail_tag">
                <p id="market_detail_cate">{{market.category}}</p>
                <p id="market_detail_loca">{{market.city}}</p>
                <p>{{market.status}}</p>
            </div>
        </div>
        <button class="market_like" data-market-id="{{market.item_id}}">
            {% if is_zzim %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill red" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                </svg>
            {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
                </svg>
            {% endif %}
        </button>
    </div>
    <div class="market_detail_mid_title">
        <div class="market_detail_profile">
            <p>{{market.user}} </p>
            <p class="market_detail_temp">{{trust_score}}</p>
        </div> 
        <div class="market_detail_tradeWay">
            <p>{{market.get_trade_type_display}}</p>
        </div>
        <p class="market_deatil_date">
            {% if market.updated_at and market.updated_at != market.created_at %}
                {{market.updated_at|date:"Y-m-d"}}
            {% else %}
                {{market.created_at|date:"Y-m-d"}}
            {%endif%}
        </p>
    </div>
</div>
<div class="market_detail_body">
    {% if market.photo %}
        <img src="{{ market.photo.url }}" alt="거래 이미지">
    {% else %}
        <p>이미지가 없습니다.</p>
    {% endif %}
    <div class="market_detail_body_right">
        <div class="market_detail_trade_location">
            <h3>거래 장소</h3>
            <p>{{market.city}}</p>
        </div>
        <div class="market_detail_price">
            <h3>가격</h3>
            <p>{{market.price}}</p>
        </div>
        <div class="market_detail_description">
            <h3>본문</h3>
            <p>{{market.explanation}}</p>
        </div>
    </div>
</div>
    {% if request.user == market.user %}
        <div class="market_detail_bottom">
            <a href="{% url 'market:market_delete' market.item_id %}" class="market_detail_edit_btn">
                <p>삭제하기</p>
            </a>
            <a href="{% url 'market:market_update' market.item_id %}" class="market_detail_edit_btn">
                <p>수정하기</p>
            </a>
        </div>
    {% else %}
        <div class="market_detail_bottom">
            <a href="#" class="market_detail_chat_btn">
                <img src="/static/img/chat_icon.svg">
                <p>채팅하기</p>
            </a>
        </div>
    {%endif%}


    <script>
    document.addEventListener("DOMContentLoaded", function(){
        document.querySelectorAll(".market_like").forEach(button => {
            button.addEventListener("click",function(){
                let marketId = this.getAttribute("data-market-id");
                let csrf_token = "{{csrf_token}}";

                fetch(`/zzim/${marketId}/`,{
                    method : "POST",
                    headers: {
                        "X-CSRFToken" : csrf_token,
                        "Content-Type": "application/json"
                    },
                credentials : "same-origin"
                })
                .then(response => response.json())
                .then(data => {
                    if(data.zzim){
                        this.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill red" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                    </svg>`;
                    }else{
                        this.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                    <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
                    </svg>`;
                    }
                })
                .catch(error => console.error("Error: ",error));
            })
        })
    })

        {% comment %} document.addEventListener("DOMContentLoaded", function() {
            const likeIcon = document.getElementById("like_icon");
            const marketId = "{{ market.pk }}";
    

            // 페이지 로드 시, 찜 상태 확인 후 아이콘 설정
            function updateLikeIcon(isZzimmed) {
                likeIcon.src = isZzimmed ? "{% static 'img/heart_icon.png' %}" : "{% static 'img/heart_empty.png' %}";
            }
    
            // 찜 기능 토글
            function toggleZzim(marketId) {
                fetch(`/market/${marketId}/zzim/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                })
                .then(response => response.json())
                .then(data => {
                    updateLikeIcon(data.zzimmed);
                })
                .catch(error => console.error("Error:", error));
            }

            // 이벤트 리스너 설정
            likeIcon.addEventListener("click", function() {
                toggleZzim(marketId);
            });
        }); {% endcomment %}
    </script>

{% endblock %}