{% extends "base/base.html" %}
{% load static %}

{% block head %} 
<link rel="stylesheet" href="{% static 'flash/flash_list.css' %}">
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZLQne-DOUQDfifh3ZP_79TmL2OmBOI7k&callback=initMap"></script>
{% endblock %}

{% block header_content %}
<a id="myPage" href="#">My Page</a>
{% endblock %}

{% block content %}
<!-- 지도 위 문구 -->
<section class="flash_title">
    <h2>여행 속 반짝이는 만남, <span class="highlight">번개 모임</span> > 번개 찾기</h2>
</section>

<div class="flash_container">
    <!-- 지도 -->
    <div class="flash_left">
        <section class="flash_list_header">
            <h2 class="flash_list_title">12개의 모집중인 번 개</h2>
            <div class="flash_list_controls">
                <h2>나만의 번개</h2>
                <a href="{% url 'flash:flash_register' %}" class="flash_register_btn">등록하기</a>
            </div>
        </section>
        
        <!-- 구분선 -->
        <hr class="flash_list_divider">
        
        <!-- 모집 중인 번개 리스트 -->        
        <section class="flash_list">
            <section class="flash_list_body">
                <div class="flash_card">
                    <a href="{% url 'flash:flash_detail' pk=1 %}" class="flash_card_link">
                        <img src="{% static 'img/flash_meeting1.png' %}" alt="모임 이미지">
                        <div class="flash_card_info">
                            <h3>토트넘 경기보면서 맥주 드실 분~</h3>
                            <p class="flash_place">123 High Street,London, SW1A 1AA United Kingdom</p>
                            <p class="flash_date">2025년 01월 11일 12:00</p>
                            <div class="flash_card_tags">
                                <span class="flash_tag">#남녀무관</span>
                                <span class="flash_tag">#타팬환영</span>
                                <span class="flash_capacity">1/4</span>
                            </div>
                        </div>
                    </a>
                </div>
                {% for flash in flash_meetings %}
                <div class="flash_card">
                    <a href="{% url 'flash:flash_detail' flash.meeting_id %}">
                        <img src="{% static 'img/flash_meeting1.png' %}" alt="모임 이미지">
                    </a>
                    <div class="flash_card_info">
                        <h3><a href="{% url 'flash:flash_detail' flash.meeting_id %}">{{ flash.title }}</a></h3>
                        <p class="flash_place">{{ flash.city }}</p>
                        <p class="flash_date">{{ flash.date_time|date:"Y년 m월 d일 H:i" }}</p>
                        <div class="flash_card_tags">
                            {% for tag in flash.tag_list %}
                                <span class="flash_tag">#{{ tag }}</span>
                            {% empty %}
                                <span class="flash_tag">태그 없음</span>
                            {% endfor %}
                        </div>
                        <span class="flash_capacity">{{ flash.max_people }}</span>
                    </div>
                </div>
                {% empty %}
                <p>등록된 번개 모임이 없습니다.</p>
                {% endfor %}
            </section>
            
        </section>
    </div>

    <section class="flash_map">
        <div id="map"></div>
    </section>
    
</div>

<script>
    function initMap() {
        const dafualt_place = { lat: 37.5665, lng: 126.9780 };  // 기본 지도 위치 (서울)
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: dafualt_place
        });

        const flashMeetings = [
            {% for flash in flash_meetings %}
                { lat: {{ flash.latitude }},
                  lng: {{ flash.longitude }},
                  title: "{{ flash.title }}" ,
                  date: "{{ flash.date_time|date:'Y-m-d H:i' }}",
                  url: "{% url 'flash:flash_detail' flash.meeting_id %}"
                },
            {% endfor %}
        ];

        flashMeetings.forEach(meeting => {
            const marker = new google.maps.Marker({
                position: { lat: meeting.lat, lng: meeting.lng },
                map,
                title: meeting.title
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<div>
                            <h3>${meeting.title}</h3>
                            <p>📅 ${meeting.date}</p>
                            <a href="${meeting.url}" target="_blank">상세보기</a>
                          </div>`,
            });
            /* 마커 클릭 시 infowindow*/
            marker.addListener("click", function() {
                infoWindow.open(map, marker);
            });
        });
    }
</script>

{% endblock %}
