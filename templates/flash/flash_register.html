{% extends "base/base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'flash/flash_register.css' %}">
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZLQne-DOUQDfifh3ZP_79TmL2OmBOI7k&callback=initMap"></script>
{% endblock %}

{% block header_content %}
<a id="myPage" href="#">My Page</a>
{% endblock %}

{% block content %}
<section class="flash_register">
    <section class="flash_title">
        <h2>여행 속 반짝이는 만남, <span class="highlight">번개 모임</span> > 번개 등록</h2>
    </section>
    
    <section class="flash_map">
        <div id="map"></div>
    </section>

    <form method="POST" class="flash_register_form">
        {% csrf_token %}
    
        <input type="hidden" id="latitude" name="latitude" value="{{ flash.latitude|default:'' }}">
        <input type="hidden" id="longitude" name="longitude" value="{{ flash.longitude|default:'' }}">
    
        <div class="input_group">
            <label for="title">*번개명</label>
            <input type="text" id="title" name="title" placeholder="번개명을 입력하세요" required value="{{ flash.title|default:'' }}">
        </div>
    
        <div class="input_group">
            <label for="location">*장소</label>
            <input type="text" id="location" name="location" placeholder="장소를 입력하세요" required value="{{ flash.city|default:'' }}">
        </div>
    
        <div class="input_group">
            <label for="date">*일시</label>
            <input type="datetime-local" id="date" name="date" required value="{{ flash.date_time|date:'Y-m-d\TH:i' }}">
        </div>
    
        <div class="input_group">
            <div class="capacity_select_container">
                <span for="capacity">인원</span>
                <select id="capacity" name="capacity">
                    <option value="1" {% if flash.max_people == 1 %}selected{% endif %}>1</option>
                    <option value="2" {% if flash.max_people == 2 %}selected{% endif %}>2</option>
                    <option value="3" {% if flash.max_people == 3 %}selected{% endif %}>3</option>
                    <option value="4" {% if flash.max_people == 4 %}selected{% endif %}>4</option>
                    <option value="5" {% if flash.max_people == 5 %}selected{% endif %}>5+</option>
                </select>
            </div>
        </div>
    
        <div class="input_group">
            <span for="tag">태그 등록</span>
            <div class="tag_input_container">
                <input type="text" id="tag_input" placeholder="#태그 입력">
                <button type="button" id="add_tag_btn">+</button>
            </div>
            <div class="tag_list"></div>
            <input type="hidden" name="tags" id="tags_hidden" value="{{ flash.tags|default:'' }}">
        </div>
    
        <div class="input_group">
            <label for="description">내용 입력</label>
            <textarea id="description" name="description" rows="4" placeholder="내용을 입력하세요">{{ flash.explanation|default:'' }}</textarea>
        </div>
    
        <button type="submit" class="flash_submit_btn">{% if edit_mode %}수정 완료{% else %}등록{% endif %}</button>
    </form>    
</section>

<script>
    function initMap() {
        console.log("initMap 실행됨");

        const defaultLocation = { lat: 37.5665, lng: 126.9780 }; // 기본 위치: 서울
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: defaultLocation
        });

        let marker = new google.maps.Marker({
            position: defaultLocation,
            map: map,
            draggable: true
        });

        // Geocoder 인스턴스 생성 (위도/경도를 주소로 변환)
        const geocoder = new google.maps.Geocoder();

        // 사용자가 지도 클릭하면 마커 이동 + 위도/경도 업데이트 + 주소 가져오기
        google.maps.event.addListener(map, "click", function(event) {
            updateLocation(event.latLng, geocoder, marker);
        });

        // 마커를 드래그해서 위치 변경할 때
        google.maps.event.addListener(marker, "dragend", function(event) {
            updateLocation(event.latLng, geocoder, marker);
        });

        // 기존 데이터가 있으면 해당 위치로 이동
        const existingLat = parseFloat(document.getElementById("latitude").value);
        const existingLng = parseFloat(document.getElementById("longitude").value);
        if (!isNaN(existingLat) && !isNaN(existingLng) && existingLat !== 0 && existingLng !== 0) {
            const existingLocation = { lat: existingLat, lng: existingLng };
            map.setCenter(existingLocation);
            marker.setPosition(existingLocation);
            updateLocation(existingLocation, geocoder, marker);
        }
    }

    function updateLocation(latLng, geocoder, marker) {
        marker.setPosition(latLng);
        document.getElementById("latitude").value = latLng.lat();
        document.getElementById("longitude").value = latLng.lng();

        // Geocoder를 사용하여 주소 변환
        geocoder.geocode({ location: latLng }, function(results, status) {
            if (status === "OK") {
                if (results[0]) {
                    document.getElementById("location").value = results[0].formatted_address;
                } else {
                    document.getElementById("location").value = "주소를 찾을 수 없음";
                }
            } else {
                console.error("Geocoder 실패: " + status);
                document.getElementById("location").value = "주소 변환 오류";
            }
        });
    }


    document.addEventListener("DOMContentLoaded", function() {
        const addTagBtn = document.getElementById("add_tag_btn");
        const tagInput = document.getElementById("tag_input");
        const tagList = document.querySelector(".tag_list");
        const tagsHiddenInput = document.getElementById("tags_hidden");

        let tagsArray = tagsHiddenInput.value ? tagsHiddenInput.value.split(",") :[];

        addTagBtn.addEventListener("click", function() {
            let tagValue = tagInput.value.trim();
            if (tagValue !== "" && !tagsArray.includes(tagValue)) {
                tagsArray.push(tagValue);
                updateTagsDisplay();
                tagInput.value = "";
            }
        });

        function updateTagsDisplay() {
            tagList.innerHTML = "";
            tagsArray.forEach(tag => {
                const tagItem = document.createElement("span");
                tagItem.classList.add("tag_item");
                tagItem.textContent = "#" + tag;

                const removeBtn = document.createElement("button");
                removeBtn.classList.add("tag_remove_btn");
                removeBtn.textContent = "x";
                removeBtn.addEventListener("click", function() {
                    tagsArray = tagsArray.filter(t => t !== tag);
                    updateTagsDisplay();
                });

                tagItem.appendChild(removeBtn);
                tagList.appendChild(tagItem);
            });

            // 태그들을 쉼표로 연결하여 hidden input에 저장
            tagsHiddenInput.value = tagsArray.join(",");
        }

        addTagBtn.addEventListener("click", function() {
            let tagValue = tagInput.value.trim();
            if (tagValue !== "" && !tagsArray.includes(tagValue)) {
                tagsArray.push(tagValue);
                updateTagsDisplay();
                tagInput.value = "";
            }
        });

        // 페이지 로드 시 기존 태그 렌더링
        updateTagsDisplay();
    });
</script>


{% endblock %}
